---
import Layout from "../../layouts/Layout.astro";
import Person from "../../components/Person.astro";
import AddPerson from "../../components/AddPerson.astro";
import Logo from "../../components/Logo.astro";
const { roomId } = Astro.params;

// import { db, Room } from "astro:db";
// const room = await db.select().from(Room).where("id", roomId);


import { turso } from '../../turso'
const { rows } = await turso.execute({
  sql: 'SELECT * FROM Room WHERE id = ?',
  args: [roomId]
});

if (rows.length === 0) {
  turso.execute({
    sql: 'INSERT INTO Room (id, name, alterDate) VALUES (?,?,?)',
    args: [roomId, roomId, new Date()]
  });
}
---
<Layout title="Your turn">
  <div class="flex items-center space-x-4">
    <a href="/"><Logo width={100} height={100} /></a>
    <h1 class="text-2xl font-bold" id="room-name">{roomId}</h1>
  </div>
  <div class="space-y-4">
    <Person id="1" yourTurn={true}>Kevin</Person>
    <Person id="2" yourTurn={false}>Desi</Person>
    <Person id="3" yourTurn={false}>Alex</Person>
    <AddPerson />
  </div>
</Layout>
<script>
  const roomElement = document.getElementById("room-name");

  const edit = () => {
    if(!roomElement) return;
    roomElement.innerHTML = `<input type="text" value="${roomElement.innerHTML}" id="room-name-edit" class="border border-gray-300 rounded-md px-4 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500" minlength="3" maxlength="30" />`;
    roomElement.removeEventListener("click", edit);
    const roomEditElement = document.getElementById("room-name-edit");
    if (!roomEditElement) return;
    roomEditElement.focus();
    roomEditElement.addEventListener("keydown", acceptEdit);
  };

  const acceptEdit = (event) => {
    if (event.key === "Enter") {
      const roomEditElement = document.getElementById("room-name-edit");
      if (!roomEditElement) return;
      roomElement.innerHTML = roomEditElement.value;
      roomElement.addEventListener("click", edit);
    }
  };

  if (roomElement) {
    roomElement.addEventListener("click", edit);
  }
</script>
